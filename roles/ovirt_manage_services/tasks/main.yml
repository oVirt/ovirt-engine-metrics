---
- name: Manage services
  ansible.builtin.service:
    name: '{{ item }}'
    state: '{{ service_state }}'
    enabled: '{{ service_enabled }}'
  with_items: '{{ service_name }}'
  failed_when: false

- name: List hosts that Collectd, Fluentd/Rsyslog are not running on
  when: not cleanup_services|d(false)
  block:
    - name: Run initial validations sub-role
      ansible.builtin.include_role:
        name: "ovirt_initial_validations"

    - name: Set service_name fact when logging_collector is rsyslog
      ansible.builtin.set_fact:
        service_name:
          - collectd
          - rsyslog
      when: logging_collector == "rsyslog"

    - name: Set service_name fact when logging_collector is fluentd
      ansible.builtin.set_fact:
        service_name:
          - collectd
          - fluentd
      when: logging_collector == "fluentd"

    - name: Check service status
      ansible.builtin.command: systemctl status "{{ item }}"
      with_items:
        - '{{ service_name }}'
      register: result
      ignore_errors: true
      changed_when: false

    - name: Clean file
      ansible.builtin.copy:
        dest: '{{ hosts_not_configured_for_ovirt_metrics_file_path }}'
        content: '# This file lists hosts where some of the oVirt metrics related services are not active in'
        force: true
        mode: "0644"
      delegate_to: localhost

    - name: Add line to file if service is not running
      ansible.builtin.lineinfile:
        path: '{{ hosts_not_configured_for_ovirt_metrics_file_path }}'
        line: "{{ ansible_facts['nodename'] }}\n{{ item.stdout_lines | to_nice_yaml }}"
      loop: "{{ result.results }}"
      when:
        - item.rc != 0
      delegate_to: localhost

    - name: Print debug message
      ansible.builtin.debug:
        msg:
          - 'Please review hosts list who are not configured for oVirt metrics,'
          - 'due to inactive ovirt metrics related services, at {{ hosts_not_configured_for_ovirt_metrics_file_path }}'
      run_once: true

- name: Cleanup oVirt metrics services
  when: cleanup_services|d(false)
  block:
    - name: Set facts to Configure rsyslog to default state
      ansible.builtin.set_fact:
        logging_inputs:
          - name: basic_input
            type: basics
        logging_outputs:
          - name: default_files
            type: files
        logging_flows:
          - name: basic-flow
            inputs: [basic_input]
            outputs: [default_files]

    - name: Set logging_purge_confs to remove oVirt metrics store configurations from Rsyslog
      ansible.builtin.set_fact:
        logging_purge_confs: true

    - name: Run rsyslog sub-role
      ansible.builtin.include_role:
        name: linux-system-roles.logging

    - name: Check if elasticsearch_host is set
      ansible.builtin.debug:
        msg: "Please delete the value of 'elasticsearch_host' from your your configuration file."
      when:
        - elasticsearch_host is defined
        - elasticsearch_host|length > 0

    - name: Check if fluentd_elasticsearch_host is set
      ansible.builtin.debug:
        msg: "Please delete the value of 'fluentd_elasticsearch_host' from your your configuration file"
      when:
        - fluentd_elasticsearch_host is defined
        - fluentd_elasticsearch_host|length > 0
